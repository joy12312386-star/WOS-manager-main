// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id                    String   @id @default(cuid())
  gameId                String   @unique
  password              String
  nickname              String?
  kid                   Int?
  stoveLv               Int?
  avatarImage           String?
  allianceId            String?
  allianceName          String?
  coordinateX           Int?
  coordinateY           Int?
  powerPoints           Int?
  T11Status             String?
  isAdmin               Boolean  @default(false)
  managedAlliances      String?  // JSON 格式存儲管理員可管理的聯盟列表，如 ["TWD","NTD"]，null 表示可管理所有聯盟
  canAssignOfficers     Boolean  @default(true)  // 是否可分配官職
  canManageEvents       Boolean  @default(true)  // 是否可設定場次
  parentUserId          String?  // 主帳號 ID，如果為 null 則自己就是主帳號
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  parentUser            User?    @relation("SubAccounts", fields: [parentUserId], references: [id], onDelete: SetNull)
  subAccounts           User[]   @relation("SubAccounts")

  submissions           TimeslotSubmission[]
  statistics            AllianceStatistic[]
  applications          SVSApplication[]
  positions             PlayerPosition[]
  auditLogs             AuditLog[]

  @@index([gameId])
  @@index([allianceId])
  @@index([isAdmin])
  @@index([parentUserId])
}

model TimeslotSubmission {
  id                    String   @id @default(cuid())
  userId                String
  fid                   String
  gameId                String
  playerName            String
  alliance              String
  eventDate             String?  // 報名的場次日期
  slotsData             String   @db.Text // JSON string to store slots data (can be large)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([alliance])
  @@index([eventDate])
}

model AllianceStatistic {
  id                    String   @id @default(cuid())
  allianceId            String
  userId                String
  allianceName          String
  totalMembersT11       Int      @default(0)
  totalMembersT10       Int      @default(0)
  totalMembers          Int      @default(0)
  totalFireSparkle      Int      @default(0)
  totalFireGem          Int      @default(0)
  totalResearchAccel    Int      @default(0)
  totalGeneralAccel     Int      @default(0)
  statisticDate         DateTime
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([allianceId])
  @@index([userId])
  @@index([statisticDate])
}

model SVSApplication {
  id                    String   @id @default(cuid())
  userId                String
  allianceId            String
  allianceName          String
  applicationDate       DateTime
  status                String   @default("pending")
  notes                 String?
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([allianceId])
  @@index([status])
}

model PlayerPosition {
  id                    String   @id @default(cuid())
  userId                String
  allianceId            String
  position              String
  isOfficer             Boolean  @default(false)
  assignedDate          DateTime
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([allianceId])
}

model AuditLog {
  id                    String   @id @default(cuid())
  userId                String?
  action                String
  targetTable           String
  targetId              String?
  changes               String?
  createdAt             DateTime @default(now())

  user                  User?    @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([action])
  @@index([createdAt])
}

model AdminSettings {
  id                    String   @id @default(cuid())
  settingKey            String   @unique
  settingValue          String
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([settingKey])
}

// 官職配置 - 按場次日期儲存
model OfficerAssignment {
  id                    String   @id @default(cuid())
  eventDate             String   // 場次日期 YYYY-MM-DD
  officerType           String   // research, training, building
  utcOffset             String   @default("00:00") // UTC 開始時間
  slotsData             String   @db.Text // JSON string: 時段分配資料 (can be large)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@unique([eventDate, officerType])
  @@index([eventDate])
  @@index([officerType])
}

// 場次管理
model Event {
  id                    String   @id @default(cuid())
  eventDate             String   @unique // 場次日期 YYYY-MM-DD
  title                 String?  // 場次標題（可選）
  status                String   @default("open") // open: 開放報名, closed: 截止報名, disabled: 關閉
  registrationStart     DateTime // 報名開始時間
  registrationEnd       DateTime // 報名結束時間
  description           String?  // 場次描述（可選）
  dayConfig             String?  // 每日活動類型配置 JSON: { monday: 'research' | 'training' | 'building', ... }
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  slotConfiguration     EventSlotConfiguration? // 一對一關係：場次與其時間槽配置

  @@index([eventDate])
  @@index([status])
  @@index([registrationEnd])
}

// 場次預設時間槽配置
model EventSlotConfiguration {
  id                    String   @id @default(cuid())
  eventId               String   @unique
  // 存儲預設時間槽配置 JSON 格式: { monday: SlotSubmission, tuesday: SlotSubmission, ... }
  defaultSlots          String   // JSON string
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  event                 Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([eventId])
}

// 聯盟地圖
model AllianceMap {
  id                    String   @id @default(cuid())
  title                 String   // 地圖標題
  status                String   @default("open") // open: 開放, closed: 截止
  alliances             String   @db.Text // JSON: 聯盟列表
  gridData              String   @db.Text // JSON: 格子聯盟分配
  gridOwners            String   @db.Text // JSON: 格子擁有者
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([status])
  @@index([createdAt])
}
